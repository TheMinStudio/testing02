<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>จองเกม 24</title>
<style>
body {margin:0;height:100vh;background:#0d1117;display:flex;justify-content:center;align-items:center;font-family:Arial;color:white;}
.card {background:#161b22;padding:30px;border-radius:12px;width:300px;}
input, button {width:100%;padding:12px;margin-top:12px;border-radius:8px;border:none;}
button {background:#2ea043;color:white;font-size:16px;cursor:pointer;}
.loading {position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;flex-direction:column;justify-content:center;align-items:center;}
.loading.show {display:flex;}
.queue {font-size:64px;color:#58a6ff;}
</style>
</head>
<body>

<div class="card">
  <h2>จองเกม 24</h2>
  <input id="name" placeholder="ชื่อ">
  <input id="class" placeholder="ชั้น/เบอร์โทร">
  <button onclick="reserve()">จอง</button>
</div>

<div id="loading" class="loading">
  <div>ตอนนี้คิวที่</div>
  <div id="queue" class="queue">⏳</div>
</div>

<audio id="alertSound" src="https://www.myinstants.com/media/sounds/bell.mp3"></audio>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz68xgRvKN6x8_rihCBKtprB5X6K8by6goYBhbIVhc84-Zl4BxZKqUdDd4SVfJ57Wpb/exec"; // ใส่ URL ของ Web App

let userName = "";
let intervalId = null;

function reserve() {
  userName = document.getElementById("name").value.trim();
  const cls = document.getElementById("class").value.trim();
  if (!userName || !cls) return;

  document.getElementById("loading").classList.add("show");
  document.getElementById("queue").innerText = "⏳";

  fetch(WEB_APP_URL, {
    method: "POST",
    body: new URLSearchParams({
      name: userName,
      className: cls,
      game: "24Game"
    })
  })
  .then(() => {
    intervalId = setInterval(updateQueue, 2000);
    updateQueue(); // เรียกครั้งแรก
  })
  .catch(err => {
    console.error(err);
    document.getElementById("queue").innerText = "ERR";
  });
}

function notifyUser(msg) {
  if (Notification.permission === "granted") {
    new Notification(msg);
  } else if (Notification.permission !== "denied") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") new Notification(msg);
    });
  }
}

function updateQueue() {
  fetch(`${WEB_APP_URL}?name=${encodeURIComponent(userName)}&game=24Game`)
    .then(r => r.text())
    .then(q => {
      const qInt = parseInt(q);
      const queueEl = document.getElementById("queue");
      if (isNaN(qInt) || qInt === 0) {
        queueEl.innerText = "…";
      } else {
        queueEl.innerText = qInt;
      }

      if (qInt === 1) {
        document.getElementById("alertSound").play();
        notifyUser("ถึงคิวคุณแล้ว!");
        clearInterval(intervalId);
      }
    })
    .catch(err => {
      console.error(err);
      document.getElementById("queue").innerText = "ERR";
    });
}
</script>

</body>
</html>
